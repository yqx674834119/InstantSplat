# InstantSplat API 目录结构修改任务

## 任务时间
2025年1月9日

## 任务目标
根据 `/home/livablecity/InstantSplat/scripts/run_infer.sh` 脚本的要求，重新组织文件存储结构，确保API上传的文件符合InstantSplat标准目录结构。

## run_infer.sh 脚本分析

### 目录结构要求
1. **输入目录结构**：
   - `DATA_ROOT_DIR/DATASET/SCENE/images/` - 存放输入图像
   - 例如：`assets/mydata/CAR/images/`

2. **中间文件目录**：
   - `DATA_ROOT_DIR/DATASET/SCENE/sparse_3/` - 存放处理过程中的中间文件
   - 例如：`assets/mydata/CAR/sparse_3/`

3. **输出目录结构**：
   - `output_infer/DATASET/SCENE/N_views/` - 存放最终输出
   - 例如：`output_infer/mydata/CAR/12_views/`

### 脚本参数传递
- `SOURCE_PATH=${DATA_ROOT_DIR}/${DATASET}/${SCENE}/`
- `MODEL_PATH=./output_infer/${DATASET}/${SCENE}/${N_VIEW}_views`
- `IMAGE_PATH=${SOURCE_PATH}images`

### 处理流程
1. **几何初始化**：`init_geo.py -s ${SOURCE_PATH} -m ${MODEL_PATH} --n_views ${N_VIEW}`
2. **模型训练**：`train.py -s ${SOURCE_PATH} -m ${MODEL_PATH} --n_views ${N_VIEW}`
3. **渲染生成**：`render.py -s ${SOURCE_PATH} -m ${MODEL_PATH} --n_views ${N_VIEW}`

## 已完成的修改

### 1. api_server.py 修改
- ✅ 修改文件上传逻辑，创建标准目录结构：`assets/api_uploads/task_id/images/`
- ✅ 更新任务参数，添加 `scene_path` 和 `images_path` 字段
- ✅ 修改 `process_image_task` 函数，使用 `scene_path` 参数调用重建处理器

### 2. reconstruction_processor.py 修改
- ✅ 修改 `process_reconstruction` 方法参数从 `frames_dir, output_dir` 改为 `scene_path`
- ✅ 删除 `_prepare_input_directory` 方法（不再需要复制文件）
- ✅ 更新 `_run_geometry_initialization` 方法参数
- ✅ 更新 `_run_training` 方法参数
- ✅ 更新 `_run_rendering` 方法参数
- ✅ 删除 `_cleanup_temp_files` 方法

## 当前目录结构

### API上传文件结构
```
assets/
└── api_uploads/
    └── {task_id}/
        └── images/
            ├── image1.jpg
            ├── image2.jpg
            └── ...
```

### 处理过程中生成的结构
```
assets/
└── api_uploads/
    └── {task_id}/
        ├── images/          # 输入图像
        └── sparse_3/        # 中间文件（由InstantSplat自动生成）

output_infer/
└── api_uploads/
    └── {task_id}/
        └── {n_views}_views/  # 最终输出
            ├── 01_init_geo.log
            ├── 02_train.log
            ├── 03_render.log
            └── ...
```

## 待完成任务
- ⏳ 测试修改后的目录结构是否正常工作
- ⏳ 验证所有参数传递是否正确
- ⏳ 确保日志文件正确生成

## 注意事项
1. `scene_path` 应该指向包含 `images/` 子目录的场景目录
2. InstantSplat会自动在场景目录下创建 `sparse_3/` 中间文件目录
3. 输出目录格式为 `output_infer/{dataset}/{scene}/{n_views}_views/`
4. 所有脚本调用都使用 `-s` 参数指定源路径，`-m` 参数指定模型输出路径